<!DOCTYPE html>

<html>
<meta charset="utf-8" />
<link rel="stylesheet" href="css/boliden.css" />
<title>Fleet Monitor</title>
<script src="js/soa004.js" type="text/javascript"></script>
<script src="js/maximo.js" type="text/javascript"></script>
<script src="js/xmlToJSON.js" type="text/javascript"></script>

<body>
  <header>
    <table id="control">
      <td class="logo">
        <a href="http://bolsrv0406.boliden.internal/asset_monitor" id="logo"> </a>
      </td>
      <td>Department<br/><select id='department'>
          <option value="All">All</option>
                    <option value="Development">Development</option>
                    <option value="Production">Production</option>
          </select>
      </td>
      <td>Priority<select id='priority' onChange="update();">
          <option value=1>Priority 1</option>
          <option value=2>Priority 2</option>
          <option value=3>Priority 3</option>
          <option value=99>Any</option>
        </select>
      </td>
      <td>Running<select id='running' onChange="update();">
          <option value="All">All</option>
          <option value="Available">Available</option>
          <option value="Down">Down</option>
        </select>
      </td>
      <td>
        <select id='displaylist' onChange="update();">
          <option value=1>Simple</option>
          <option value=2>Include Service</option>
          <option value=3>First Service Availibility</option>
          <option value=4>All Services</option>
          </select>
        <select id='lookbacklist' onChange="update();">
          <option value=5>5 Minutes</option>
          <option value=15>15 Minutes</option>
          <option value=30>30 Minutes</option>
          <option value=360>6 Hours</option>
          <option value=720>12 Hours</option>
          <option value=1440>Day</option>
          </select>
      </td>
      <tr>
        <td class="logo" rowspan="3" id="lastrun">Waiting on network.....</td>
        <td class="assetup">Up</td>
        <td class="assetdown">Down</td>
        <td class="assetdown2">Down in Progress</td>
        <td class="assetservice">Servicing</td>
      </tr>
      <tr>
        <td class="assetup"><span id="assetupcount"></span></td>
        <td class="assetdown"><span id="assetdowncount"></span></td>
        <td class="assetdown2"><span id="assetbreakdowncount"></span></td>
        <td class="assetservice"><span id="assetservice"></span></td>
      </tr>
      <tr>
        <td class="assetup"><span id="uppct"></span></td>
        <td class="assetdown"><span id="downpct"></span></td>
        <td class="assetdown2"><span id="breakpct"></span></td>
        <td class="assetservice"><span id="servicepct"></span></td>
    </table>
  </header>
  <tr>
    <tr/>
    <table id="output">
      <td id="messup" class="assetuplist"></td>
      <td id="messdown" class="assetdownlist"></td>
    </table>

    <table id="tgt">
      <thead></thead>
      <tbody></tbody>
    </table>

    <script>
      var interval = 300000;
      var lookback = 5;
      var mindisplay = 1;
      var maxdisplay = 4;
      var maxmins = 1440;
      var minmins = 15;
      var heartbeat = true;

      var debug = false;
      //		var searchfilter = {maxrows: 600,offset: 0,fields: [{SITEID:"TAR"},{ASSETTYPE:"FLEET"},{STATUS:"OPERATING"},{PRIORITY:1}]};
      var chosenpriority = 1;
      var chosendept = "All";
      var running = "All";
      var json = null;
      var newjson = null;
      var HeaderCells;
      var startdate = new Date();
      var displaylevel = 1;

      var assetupcount = 0;
      var assetdowncount = 0;
      var assetservice = 0;
      var assetbreakdowncount = 0;
      var assettotal = 0;
      var refreshpid = null;
      var updatepid = null;
      var waiting = false;


      var deptBox = document.getElementById('department');
      var priBox = document.getElementById('priority');
      var runningBox = document.getElementById('running');
      var displayBox = document.getElementById('displaylist');
      var lookbackBox = document.getElementById('lookbacklist');

      function set(id, val) {
        debug = true;
        outputconsole("set() ::" + id + ":" + val);
        debug = false;

        var el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = val;
      }

      function getbyid(id) {
        var el = document.getElementById(id);
        if (!el) return;
        return (val);
      }

      function debuglevel() {
        outputconsole("debug ::" + !debug);
        debug = !debug;
        refresh();
      }

      function UpDisplaylevel() {
        displaylevel = Math.min(displaylevel + 1, maxdisplay);
        refresh();
        set("debuglabel", displaylevel);
        outputconsole("UpDisplaylevel ::" + displaylevel);
      }

      function DownDisplaylevel() {
        displaylevel = Math.max(displaylevel - 1, mindisplay);
        refresh();
        set("debuglabel", displaylevel);
        outputconsole("DownDisplaylevel ::" + displaylevel);
      }

      function Uplookback() {
        lookback = Math.min(lookback * 2, maxmins);
        update();
        refresh();
        outputconsole("Uplookback ::" + lookback);
      }

      function Downlookback() {
        lookback = Math.max(lookback / 2, minmins);
        update();
        refresh();
        outputconsole("Downlookback ::" + lookback);
      }

      lookbackBox.onchange = function() {
        lookback = lookbackBox.options[lookbackBox.selectedIndex].value;
        update();
        refresh();
      }

      displayBox.onchange = function() {
        displaylevel = displayBox.options[displayBox.selectedIndex].value;
        refresh();
      }

      runningBox.onchange = function() {
        running = runningBox.options[runningBox.selectedIndex].value;
        refresh();
      }

      priBox.onchange = function() {
        //			chosenpriority = priBox.options[priBox.selectedIndex].value;
        //			displaytable( json );
        chosenpriority = priBox.options[priBox.selectedIndex].value;
        filterpriority = chosenpriority == 99 ? "!~null~" : chosenpriority;
        refresh();
      }

      deptBox.onchange = function() {
        chosendept = deptBox.options[deptBox.selectedIndex].value;
        refresh();
      }

      function compile(curr, downtime) {
        var d = new Date();
        var currdescription = curr.LOCATIONS[0].DESCRIPTION;
        //            currdescription += curr.CLASSSTRUCTURE[0].DESCRIPTION;
        currdescription += ".";
        currdescription += curr.CLASSSTRUCTURE[0].DESCRIPTION;
        currdescription += ".";
        currdescription += curr.ISRUNNING === false ? 0 : 1;
        currdescription += ".";
        locald = curr.ASSETSTATUS ? new Date(curr.ASSETSTATUS[0].CHANGEDATE) : new Date(curr.CHANGEDATE);
        downtime = Math.round(daysDiff(locald, d));
        currdescription += maximo.leftpad(downtime, 10, "0");
        return currdescription;
      }

      function outputconsole(text, json) {
        if (debug) {
          if (json === undefined) {
            console.log(text);
          } else {
            var j = 0;
            var i = 0;
            var allrecords = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET.length;
            for (i = j; i < allrecords; ++i) {
              curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
              console.log(text + "::" + compile(curr));
            }
            console.log("===================");
          }
        }
      }

      function builddeptbox(json) {
        for (var j = deptBox.options.length - 1; j >= 0; j--) {
          deptBox.remove(j); // Clears all old values
        }
        currdept = "All";
        var opt = document.createElement("OPTION");
        opt.value = currdept;
        opt.text = currdept;
        deptBox.add(opt);
        for (i = 0; i < json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET.length; i++) {
          var curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
          department = curr.LOCATIONS[0].DESCRIPTION;
          if (currdept != department) {
            var opt = document.createElement("OPTION");
            opt.value = department;
            opt.text = department;
            deptBox.add(opt);
          }
          currdept = department;
        }
        deptBox.value = chosendept;
      }

      function mergejson(json, newjson) {
        if (!json || !newjson)
          return;

        var allrecords = json.QueryREST_ASSETWResponse.rsTotal;
        var newrecords = newjson.QueryREST_ASSETWResponse.rsTotal;
        if (allrecords == 0 || newrecords == 0) return;
        var i = 0;
        var j = 0;
        var message = "";
        var records = allrecords - 1;
        d = new Date();

        // stript out repeated text from department names
        for (i; i < newrecords; ++i) {
          newcurr = newjson.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
          newcurr.LOCATIONS[0].DESCRIPTION = newcurr.LOCATIONS === undefined ? "Unknown" : trimlocationdesc(newcurr.LOCATIONS[0].DESCRIPTION);
          var locald = new Date(newcurr.CHANGEDATE);
          outputconsole("merge Asset [" + newcurr.ASSETNUM + "] " + daysDiff(locald, d) + ":" + compile(newcurr));
          for (j = 0; j < allrecords; ++j) {
            curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[j];
            if (newcurr.ASSETID == curr.ASSETID) {
              json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[j] = newcurr;
            }
          }
        };
      }

      function swapnew() {
        // method swaps meters till the earliest one is first
        var records = newjson.QueryREST_ASSETWResponse.rsTotal;
        var swapnew = true;
        var curr = null;
        var newcurr = null;
        while (swapnew) {
          swapnew = false;
          var i = 0;
          d = new Date();
          for (i; i < records - 1; ++i) {
            curr = newjson.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
            newcurr = newjson.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i + 1];
            var currlocald = new Date(curr.CHANGEDATE);
            var newcurrlocald = new Date(newcurr.CHANGEDATE);
            var difference = daysDiff(newcurrlocald, currlocald);
            outputconsole("<" + curr.ASSETNUM + ":" + currlocald.toLocaleString() + "> <" + newcurr.ASSETNUM + ":" + newcurrlocald.toLocaleString() + "> diff:" + difference);
            if (difference < 0) {
              newjson.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i] = newcurr;
              newjson.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i + 1] = curr;
              swapnew = true;
            }
            outputconsole("<swapnew>", newjson);
          }
        }
        outputconsole(" xxxxxxxxxxx ");
      };

      function displaynew() {
        if (newjson) {
          var newrecords = newjson.QueryREST_ASSETWResponse.rsTotal;
          if (newrecords > 0) {
            swapnew();
            var i = 0;
            var uexists = false;
            var dexists = false;
            var umessage = "";
            var dmessage = "";
            d = new Date();
            set("messup", null);
            set("messdown", null);
            document.getElementById("output").style.display = '';
            document.getElementById("messup").style.display = '';
            document.getElementById("messdown").style.display = '';
            for (i; i < newrecords; ++i) {
              newcurr = newjson.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
              department = newcurr.LOCATIONS[0].DESCRIPTION;
              if ((newcurr.PRIORITY <= chosenpriority) &&
                (chosendept == department || chosendept == "All") &&
                ((!newcurr.ISRUNNING && running == 'Down') ||
                  running == "All" ||
                  (newcurr.ISRUNNING && running == 'Available'))) {
                var locald = new Date(newcurr.CHANGEDATE);
                message = maximo.leftpad(daysBetween(locald, d), 5, " ") + " : " + newcurr.ASSETNUM + (chosenpriority > 1 ? " (" + newcurr.PRIORITY + ") " : " ") + newcurr.DESCRIPTION;
                if (newcurr.ISRUNNING == 0) {
                  dmessage += dexists ? "<br/>" : "";
                  dmessage += message
                  dexists = true;
                } else {
                  umessage += uexists ? "<br/>" : "";
                  umessage += message
                  uexists = true;
                }
              }
            };
            if (uexists) set("messup", umessage);
            if (dexists) set("messdown", dmessage);
            if (!uexists && !dexists) {
              document.getElementById("output").style.display = 'none';
            }else {
              document.getElementById("output").style.display = '';
            }
            if (!uexists) {
              document.getElementById("messup").style.display = 'none';
            }
            if (!dexists) {
              document.getElementById("messdown").style.display = 'none';
            }
          } else {
            document.getElementById("output").style.display = 'none';
          }
        } else {
          document.getElementById("output").style.display = 'none';
        }
      }

      function setlastrun() {
        //        set("lastupdated", "Updates at " + startdate.toLocaleTimeString() + " for last " + HoursBetween(lookback, true));
        set("lookback", HoursBetween(lookback, true));
      }

      function trimlocationdesc(locationdescription) {
        return (locationdescription.replace('Mine ', '').replace(' Fleet', ''));
      }

      function sortbydept(json, dept) {
        var start = 0;
        if (!json)
          return;

        var allrecords = json.QueryREST_ASSETWResponse.rsTotal;
        if (allrecords == 0) return;
        var swap = true;
        var endstop = 0;
        var endstart = 0;
        var i = 0;
        var records = allrecords - 1;

        outputconsole("dirty", json);
        for (i = start; i < allrecords; ++i) {
          curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
          curr.LOCATIONS[0].DESCRIPTION = curr.LOCATIONS === undefined ? "Unknown" : trimlocationdesc(curr.LOCATIONS[0].DESCRIPTION);
          swapmeters(curr);
        };

        outputconsole("clean", json);
        var cdowntime = 0.0;
        var ndowntime = 0.0;
        while (swap) {
          swap = false;
          for (i = start; i < records; ++i) {
            curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
            nextcurr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i + 1];
            var currdescription = compile(curr, cdowntime);
            var nextdescription = compile(nextcurr, ndowntime);
            if (currdescription > nextdescription) {
              swap = true
              endstop = i;
              json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i + 1] = curr;
              json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i] = nextcurr;
              //						displaytable(json);
            }
          }

          outputconsole("mid:" + start + ":" + endstop, json);
          records--;
          //                records--;
          endstart = endstop - 1;
          if (!swap) break;

          swap = false;
          for (i = records; i > start; --i) {
            curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
            nextcurr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i - 1];
            var currdescription = compile(curr, cdowntime);
            var nextdescription = compile(nextcurr, ndowntime);
            if (currdescription < nextdescription) {
              swap = true
              endstop = i;
              json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i - 1] = curr;
              json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i] = nextcurr;
            }
          }
          outputconsole("end:" + start + ":" + endstop, json);
        }
        outputconsole("final", json);
      };

      function calcassetdays(curr, first) {
        var d = new Date();
        var days;
        locald = curr.ASSETSTATUS ? new Date(curr.ASSETSTATUS[0].CHANGEDATE) : new Date(curr.CHANGEDATE);
        downtime = daysBetween(locald, d);
        loop = first ? 1 : curr.ASSETMETER.length;
        if (curr.ASSETMETER) {
          for (am = 0; am < loop; am++) {
            var currmeter = curr.ASSETMETER[am];
            if (currmeter.PMMETER) {
              days = meterdays(curr, currmeter);
            }
          }
        }
        return days;
      };

      function meterdays(curr, currmeter) {
        var d = new Date();
        var days;
        if (currmeter.PMMETER) {
          for (pm = 0; pm < currmeter.PMMETER.length; pm++) {
            if (currmeter.PMMETER[pm].LASTPMWOGENREADDT) {
              reportdate = new Date(currmeter.PMMETER[pm].LASTPMWOGENREADDT);
              days = currmeter.AVERAGE == 0 ? 0 : currmeter.PMMETER[pm].FREQUENCY / currmeter.AVERAGE;
              reportdate.setDate(reportdate.getDate() + days);
              days = Math.round(daysDiff(d, reportdate) / 60.0 / 24.0);
            } else {
              reportdate = new Date(curr.INSTALLDATE);
              rate = (daysDiff(reportdate, d) / 60.0 / 24.0);
              average = currmeter.LIFETODATE / rate;
              days = Math.round(currmeter.PMMETER[pm].FREQUENCY / average);
            }
          }
          return days;
        }
      };

      function swapmeters(curr) {
        // method swaps meters till the earliest one is first
        if (curr.ASSETMETER) {
          if (curr.ASSETNUM == "264")
            stop = 0;
          var swapmeter = true;
          while (swapmeter) {
            currdays = 9999;
            nextdays = 9999;
            swapmeter = false;
            for (am = 0; am < curr.ASSETMETER.length - 1; am++) {
              currmeter = curr.ASSETMETER[am];
              nextmeter = curr.ASSETMETER[am + 1];
              if (currmeter.PMMETER)
                currdays = meterdays(curr, currmeter);
              if (nextmeter.PMMETER)
                nextdays = meterdays(curr, nextmeter);
              if (currdays > nextdays) {
                curr.ASSETMETER[am] = nextmeter;
                curr.ASSETMETER[am + 1] = currmeter;
                swapmeter = true;
              }
            }
          }
        }
      };

      function buildassetcell(curr, pmpfound, pmpservice, pmploc) {
        var d = new Date();
        var pmexists = false;
        var reportdate = new Date();
        var days = -999;
        var ass = curr.ASSETNUM;
        var lifetodate = 0.0;
        if (displaylevel > 1) {
          ass += chosenpriority > 1 ? " (" + curr.PRIORITY + ") [" : " [";
        } else {
          ass += chosenpriority > 1 ? " (" + curr.PRIORITY + ")<br/>[" : "<br/>[";
        }
        //            var locald = curr.ASSETSTATUS ? new Date(curr.ASSETSTATUS[0].CHANGEDATE) : new Date(curr.CHANGEDATE);
        var locald = curr.ASSETSTATUS ? new Date(curr.ASSETSTATUS[0].CHANGEDATE) : new Date(curr.CHANGEDATE);
        ass += daysBetween(locald, d) + "]";
        if (curr.ASSETNUM == "330")
          stop = 0;
        if (displaylevel > 1) {
          if (pmpservice) {
            reportdate = curr.WORKORDER[pmploc].SCHEDFINISH === undefined ? new Date(curr.WORKORDER[pmploc].TARGCOMPDATE) : new Date(curr.WORKORDER[pmploc].SCHEDFINISH);
            days = Math.round(daysDiff(d, reportdate) / 60.0 / 24.0);
            ass += (days < 0 ? "<br/>Late " : "<br/>Back ") + days; //+ " Days";
            pmexists = true;
          } else if (curr.ASSETMETER) {
            loop = displaylevel > 3 ? curr.ASSETMETER.length : 1;
            for (am = 0; am < loop; am++) {
              currmeter = curr.ASSETMETER[am];
              days = meterdays(curr, currmeter);
              if (days !== undefined) {
                pmexists = true;
                ass += (days < 0 ? "<br/>Late " : "<br/>Due ") + days; // + " Days";
              }
            }
          }
          if (!pmexists)
            ass += "<late style='color:black'></br>No PM";
        }
        if (displaylevel > 2) {
          reportdate = curr.INSTALLDATE === undefined ? new Date(curr.STATUSDATE) : new Date(curr.INSTALLDATE);
          rate = daysDiff(reportdate, d) / 60.0;
          avail = Math.round(10000 * (1 - (curr.TOTDOWNTIME / rate))) / 100;
          ass += "<br/>Avail " + avail + "%";
        }

        return ass;
      }

      function buildassettitle(curr, pmpfound, pmpservice, pmploc) {
        var asstitle = "";

        asstitle = curr.ASSETNUM + "<br/>"
        if (pmpfound && !pmpservice) {
          if (curr.WORKORDER[pmploc].SCHEDSTART) {
            schdate = new Date(curr.WORKORDER[pmploc].SCHEDSTART);
            asstitle += "Service Scheduled:" + schdate.toLocaleDateString() + "<br/><br/>";
          } else {
            schdate = new Date(curr.WORKORDER[pmploc].STATUSDATE);
            asstitle += "Target Service:" + schdate.toLocaleDateString() + "<br/><br/>";
          }
        }

        if (curr.ASSETNUM == "330")
          stop = 0;

        if (curr.WORKORDER) {
          for (w = 0; w < curr.WORKORDER.length; w++) {
            var reportdate = new Date(curr.WORKORDER[w].REPORTDATE);
            asstitle += "<a href='http://maximoprod.boliden.internal/maximo/ui/maximo.jsp?event=loadapp&amp;value=WOTRACK&amp;uniqueid=";
            asstitle += curr.WORKORDER[w].WORKORDERID + "' target='_blank'>";
            asstitle += curr.WORKORDER[w].WONUM + "</a>";
            asstitle += " [" + reportdate.toLocaleDateString() + "] ";
            asstitle += curr.WORKORDER[w].AMCREW === undefined ? "" : curr.WORKORDER[w].AMCREW[0].DESCRIPTION;
            asstitle += "<br/>" + curr.WORKORDER[w].DESCRIPTION;
            asstitle += curr.WORKORDER[w].DESCRIPTION_LONGDESCRIPTION === undefined ? "" : ". <br/>" + curr.WORKORDER[w].DESCRIPTION_LONGDESCRIPTION.replace(/<\/?[^>]+(>|$)/g, " ").replace(/&#039;/g, "'");
            if (curr.WORKORDER[w].WORKLOG) {
              asstitle += curr.WORKORDER[w].WORKLOG.DESCRIPTION === undefined ? "" : ".<br/>" + curr.WORKORDER[w].WORKLOG.DESCRIPTION;
            }
            asstitle += "<br/><br/>";
          }
          //						ass = ass+"<span class=tooltiptext>"+asstitle+"</span>";
          //						asstitle = asstitle.replace(/<\/?[^>]+(>|$)/g, "\n");
        }
        return asstitle;
      }

      function findclasspos(Hcell, title) {
        for (l = 0; l < Hcell.length; l++) {
          currsection = Hcell.item(l).innerHTML;
          if (title == currsection)
            return (l);
        }
      }

      function setassetclass(deptlabel, Hcell, curr) {
        found = true;
        if (curr.ASSETNUM == "337") stop = 0;
        pmpfound = false;
        pmpservice = false;
        assup = 0;
        assdown = 0;
        var pmploc = 0;
        if (curr.ISRUNNING) {
          deptlabel.className = curr.WORKORDER ? "assetup2" : "assetup";
          assetupcount += 1;
          assup = 1;
        } else {
          assdown = 1;
          if (curr.WORKORDER) {
            for (w = 0; w < curr.WORKORDER.length; w++) {
              if (curr.WORKORDER[w].WORKTYPE == "PMP") {
                pmpfound = true;
                pmploc = w;
              }
            }
            if (pmpfound && curr.WORKORDER[pmploc].STATUS == "INPRG") {
              deptlabel.className = "assetservice";
              assetservice += 1;
              pmpservice = true;
            } else {
              assetdowncount += 1;
              assetbreakdowncount += 1;
              if (pmpfound) {
                deptlabel.className = "assetdown";
              } else {
                deptlabel.className = "assetdown2";
              }
            }
          } else {
            deptlabel.className = "assetdown";
            assetdowncount += 1;
          }
        }

        days = calcassetdays(curr, true);
        asstitle = buildassettitle(curr, pmpfound, pmpservice, pmploc);
        ass = buildassetcell(curr, pmpfound, pmpservice, pmploc);

        if (days < 7) {
          if (pmpfound) {
            var stop = 0;
            if (!pmpservice) {
              //deptlabel.item(l).className="serviceduepmp";
            }
          } else {
            //                          deptlabel.item(l).className= curr.ISRUNNING ? "servicedueup":"serviceduedn";
            null;
          }
        }
        ass += asstitle.length > 10 ? "<span class=tooltiptext>" + asstitle + "</span>" : "";
        deptlabel.innerHTML = ass;
        position = findclasspos(HeaderCells, curr.CLASSSTRUCTURE[0].DESCRIPTION);

        pcttotalobj.item(position).innerHTML = Number(pcttotalobj.item(position).innerHTML) + 1;
        pctupobj.item(position).innerHTML = Number(pctupobj.item(position).innerHTML) + assup;
        pctdownobj.item(position).innerHTML = Number(pctdownobj.item(position).innerHTML) + assdown;

      }

      function displaytable(json) {
        var tr = null;
        var cellLength = 0;
        var toptbl = null;
        var toggle = false;
        var asstitle = "";
        var department = "";
        var toptbl = document.getElementById("tgt");
        tblhead = toptbl.getElementsByTagName("thead")[0];
        tbl = toptbl.getElementsByTagName("tbody")[0];

        if (!json)
          return;

        var assetrecords = json.QueryREST_ASSETWResponse.rsCount;
        if (assetrecords == 0)
          return;

        var assetcolums = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET.length;
        var sectionname = null;
        var oldsectionname = null;
        var nocolumns = 0;
        var found = false;
        var days;
        var pmpfound = false;
        var pmpservice = false;
        var currdept = "xx";
        var pmploc = 0;

        assetupcount = 0;
        assetdowncount = 0;
        assetservice = 0;
        assetbreakdowncount = 0;
        assettotal = 0;

        builddeptbox(json);

        tablelength = toptbl.rows.length;
        for (var i = 0; i < tablelength; i++) {
          toptbl.deleteRow(0);
        }
        // start rebuild the header with the single version of the description
        tr = tblhead.insertRow(0);
        // add columns for the machine types currently using CLASSSTRUCTURE
        td = tr.insertCell(-1);
        tr.id = "depttitle";
        td.innerHTML = "Department";

        HeaderCells = toptbl.rows.item(0).cells;
        for (i = 0; i < assetcolums; i++) {
          var curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
          sectionname = curr.CLASSSTRUCTURE[0].DESCRIPTION;
          department = curr.LOCATIONS[0].DESCRIPTION;
          ass = curr.ASSETNUM;
          if ((curr.PRIORITY <= chosenpriority) &&
            (chosendept == department || chosendept == "All") &&
            ((!curr.ISRUNNING && running == 'Down') ||
              running == "All" ||
              (curr.ISRUNNING && running == 'Available'))) {
            if (nocolumns > 0) {
              HeaderCells = toptbl.rows.item(0).cells;
              //gets cells of current row
              found = false;
              cellLength = HeaderCells.length;
              for (var j = 0; j < cellLength; j++) {
                var cellVal = HeaderCells.item(j).innerHTML;
                if (sectionname === cellVal) {
                  found = true;
                }
              }
            }
            // add them to the column headers
            if (!found) {
              td = tr.insertCell(-1);
              td.innerHTML = sectionname;
              nocolumns += 1;
              oldsectionname = sectionname;
            }
            cellLength = HeaderCells.length;
          }
        }
        cellLength = HeaderCells === undefined ? 0 : HeaderCells.length;

        if (cellLength < 2) {
          toptbl.deleteRow(0);
          tr = toptbl.insertRow(0);
          td = tr.insertCell(-1);
          td.innerHTML = cellLength + " type(s) found but not with chosen options";
          return;
        }

        // run down through the cells with the logic of using the "machine classificaiton description as the sort field
        swap = true;
        while (swap) {
          swap = false;
          for (l = 1; l < HeaderCells.length - 1; l++) {
            currsection = HeaderCells.item(l).innerHTML;
            nextsection = HeaderCells.item(l + 1).innerHTML;
            if (currsection > nextsection) {
              HeaderCells.item(l).innerHTML = nextsection;
              HeaderCells.item(l + 1).innerHTML = currsection;
              swap = true;
            }
          }
        }

        tr = tblhead.insertRow(-1);
        if (displaylevel < 2) {
          tr.style.display = 'none';
        }
        tr.id = "pct";
        for (l = 1; l < HeaderCells.length + 1; l++) {
          // add columns for the machine types currently using CLASSSTRUCTURE
          td = tr.insertCell(-1);
          td.className = "assetup";
          if (l == 1) td.className = "productionh";
          td.innerHTML = 0;
        }

        tr = tblhead.insertRow(-1);
        if (displaylevel < 3) {
          tr.style.display = 'none';
        }
        tr.id = "pct1";
        for (l = 1; l < HeaderCells.length + 1; l++) {
          // add columns for the machine types currently using CLASSSTRUCTURE
          td = tr.insertCell(-1);
          td.className = "assetdown";
          if (l == 1) td.className = "productionh";
          td.innerHTML = 0;
        }

        tr = tblhead.insertRow(-1);
        tr.style.display = 'none';
        tr.id = "pctup";
        for (l = 1; l < HeaderCells.length + 1; l++) {
          // add columns for the machine types currently using CLASSSTRUCTURE
          td = tr.insertCell(-1);
          if (l == 1) td.className = "productionh";
          td.innerHTML = 0;
        }
        tr.style.display = 'none';

        tr = tblhead.insertRow(-1);
        tr.style.display = 'none';
        tr.id = "pctdown";
        for (l = 1; l < HeaderCells.length + 1; l++) {
          // add columns for the machine types currently using CLASSSTRUCTURE
          td = tr.insertCell(-1);
          td.innerHTML = 0;
          if (l == 1) td.className = "productionh";
        }
        tr = tblhead.insertRow(-1);
        tr.style.display = 'none';
        tr.id = "pcttotal";
        for (l = 1; l < HeaderCells.length + 1; l++) {
          // add columns for the machine types currently using CLASSSTRUCTURE
          td = tr.insertCell(-1);
          td.innerHTML = 0;
          if (l == 1) td.className = "productionh";
        }

        //        document.getElementById("pct").style.display = 'none';

        pcttotalobj = document.getElementById("pcttotal").cells;
        pctupobj = document.getElementById("pctup").cells;
        pctdownobj = document.getElementById("pctdown").cells;
        pct = document.getElementById("pct").cells;
        pct1 = document.getElementById("pct1").cells;

        for (i = 0; i < assetcolums; i++) {
          var curr = json.QueryREST_ASSETWResponse.REST_ASSETWSet.ASSET[i];
          department = curr.LOCATIONS[0].DESCRIPTION;
          if (
            (curr.PRIORITY <= chosenpriority) &&
            (chosendept == department || chosendept == "All") &&
            ((!curr.ISRUNNING && (running == 'Down' || running == "Available")) || running == "All")
          ) {
            sectionname = curr.CLASSSTRUCTURE[0].DESCRIPTION;
            found = false;
            // find the next available slot
            var locald;
            assettotal++;
            for (k = 0; k < tbl.rows.length; ++k) {
              if (!found) {
                deptlabel = tbl.rows.item(k).cells;
                currdept = deptlabel.item(0).innerHTML;
                if (department == currdept) {
                  position = findclasspos(HeaderCells, sectionname);
                  objecttext = deptlabel.item(position);
                  if (!objecttext.innerHTML) {
                    found = true;
                    setassetclass(objecttext, HeaderCells, curr);
                  }
                }
              }
            }
            if (!found) {
              if (curr.ASSETNUM == "337") stop = 0;
              tr = tbl.insertRow(-1);
              td = tr.insertCell(-1);
              td.innerHTML = department;
              td.className = "production" + (currdept == department ? "h" : "");
              toggle = !toggle;
              currdept = department;
              for (var j = 1; j < cellLength; j++) {
                currsection = HeaderCells.item(j).innerHTML;
                td = tr.insertCell(-1);
                if (sectionname === currsection) {
                  setassetclass(td, HeaderCells, curr)
                }
              }
            }
          }
        }

        for (var j = 1; j < pct.length; j++) {
          pct.item(j).innerHTML = Math.round(1000.0 * Number(pctupobj.item(j).innerHTML) / Number(pcttotalobj.item(j).innerHTML)) / 10 + "%";
          pct1.item(j).innerHTML = Math.round(1000.0 * Number(pctdownobj.item(j).innerHTML) / Number(pcttotalobj.item(j).innerHTML)) / 10 + "%";
        }

        set("assetupcount", assetupcount);
        set("assetdowncount", assetdowncount);
        set("assetservice", assetservice);
        set("assetbreakdowncount", assetbreakdowncount);
        set("uppct", (Math.round(1000.0 * assetupcount / assettotal) / 10.0) + "%");
        set("downpct", (Math.round(1000.0 * assetdowncount / assettotal) / 10.0) + "%");
        set("servicepct", (Math.round(1000.0 * assetservice / assettotal) / 10.0) + "%");
        set("breakpct", (Math.round(1000.0 * assetbreakdowncount / assettotal) / 10.0) + "%");
      }

      function daysDiff(date1, date2) {
        // Get 1 minute in milliseconds
        var one_min = 1000 * 60;
        var mins;
        mins = (date2.getTime() - date1.getTime()) / one_min;
        return mins;
      }

      function daysBetween(date1, date2) {
        var mins;
        var hours;
        mins = Math.floor(daysDiff(date1, date2));
        return HoursBetween(mins);
      }

      function HoursBetween(mins, full) {
        var mins;
        var hours;
        hours = Math.floor((mins / 60.0));
        mins = mins - (hours * 60.0);
        if (hours == 0) {
          downtime = mins + (full ? " Minutes" : "m");
        } else if (hours > 23) {
          days = Math.floor(hours / 2.4) / 10.0;
          downtime = (days == 1 && full ? "" : Math.floor(hours / 2.4) / 10.0) + (full ? " Day" : "D");
        } else {
          downtime = (hours == 1 && full ? "" : hours) + (full ? " Hour" : "h") + (full && hours > 1 ? "s" : "");
        }
        return downtime;
      }

      function setfilter(targetdate) {
        var filter;
        // temp to cause delta data set
        var text = ">" + targetdate.toISOString();
        if (chosenpriority == 99) {
          //          filter = {maxrows: 600,offset: 0,fields: [{SITEID:"=TAR"},{ASSETTYPE:"=FLEET"},{STATUS:"=OPERATING"},{LOCATION:"!~null~"},{CLASSSTRUCTUREID:"!~null~"}]};
          filter = {
            maxrows: 3000,
            offset: 0,
            fields: [{
              SITEID: "=TAR"
            }, {
              ASSETTYPE: "=FLEET"
            }, {
              CLASSSTRUCTUREID: "!~null~"
            }, {
              CHANGEDATE: text
            }, {
              STATUS: "=OPERATING"
            }, {
              LOCATION: "!~null~"
            }, {
              PRIORITY: "!~null~"
            }]
          };
        } else {
          //          filter = {maxrows: 600,offset: 0,fields: [{SITEID:"=TAR"},{ASSETTYPE:"=FLEET"},{STATUS:"=OPERATING,=ACTIVE"},{LOCATION:"!~null~"},{CLASSSTRUCTUREID:"!~null~"},{PRIORITY:filterpriority}]};
          filter = {
            maxrows: 3000,
            offset: 0,
            fields: [{
              SITEID: "=TAR"
            }, {
              ASSETTYPE: "=FLEET"
            }, {
              CLASSSTRUCTUREID: "!~null~"
            }, {
              CHANGEDATE: text
              //            }, {               LOCATION: "=102A"
            }, {
              STATUS: "OPERATING"
            }, {
              LOCATION: "!~null~"
            }, {
              PRIORITY: "!~null~"
            }]
          };
        }
        return filter;
      }

      function reload() {
        set("lastrun", "Waiting on network....." + startdate.toLocaleTimeString());
        tempYear = new Date(startdate);
        tempYear.setFullYear(1900);
        json = SOA004Client.get(setfilter(tempYear));
        update();
        refresh();
      }

      function refresh() {
        sortbydept(json, true);
        displaytable(json);
        displaynew();
        setlastrun();
        outputconsole("refresh() startdate ::" + startdate);
      }

      function update() {
        if (!waiting) {
          set("lastrun", "Waiting on network....." + startdate.toLocaleTimeString());
        }
        waiting = true;
        newjson = null;
        targetdate = new Date(startdate);
        targetdate.setMinutes(targetdate.getMinutes() - lookback);
        newjson = SOA004Client.get(setfilter(targetdate));
        if (newjson.error) {
          set("lastrun", json.error + "<br/>" + startdate.toLocaleString());
        } else {
          startdate = new Date();
        }
        mergejson(json, newjson);
        outputconsole("update() startdate ::" + startdate);
        set("lastrun", "Last Run:<br/>" + startdate.toLocaleString());
        waiting = false;
      }

      SOA004Client.init();
      SOA004Client.system = "MAXIMO";
      SOA004Client.dataobject = "REST_ASSETW";
      deptBox.value = "All";
      priBox.value = "1";
      runningBox.value = "All";
      displayBox.value = displaylevel;
      lookbackBox.value = lookback;

      document.getElementById("output").style.display = '';
      set("messup", "@@@@@@@@@@@@@@@@");
      set("messdown", "^^^^^^^^^^^^^^^^^");

      refreshpid = setInterval(function() {
        refresh();
      }, interval / 5);

      updatepid = setInterval(function() {
        update();
      }, interval - 200);

      reload();
    </script>

</body>

</html>
